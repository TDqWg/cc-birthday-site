
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 2rem;
    }
    h1 { text-align: center; color: #333; }
    .section {
      background: white;
      padding: 2rem;
      margin: 2rem auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    .section h2 { margin-top: 0; color: #444; }
    .btn-group button {
      background-color: gold; color: white; padding: 0.75rem 1.5rem;
      border: none; border-radius: 8px; margin: 0.5rem; cursor: pointer; font-size: 1rem;
    }
    input[type="number"] {
      width: 100%; padding: 0.5rem; margin-top: 0.5rem;
      font-size: 1rem; border: 1px solid #ccc; border-radius: 8px;
    }
    #remaining {
      font-size: 1.2rem; color: green; margin-top: 1rem; font-weight: bold;
    }
    .status {
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 1rem;
      text-align: center;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Admin Control Panel</h1>
      <div class="section">
      <h2>üé¨ Control Phase</h2>
      <div class="btn-group">
        <button onclick="sendPhase(2)">Phase 2</button>
        <button onclick="sendPhase(3)">Phase 3</button>
        <button onclick="sendPhase(4)">Phase 4</button>
      </div>
      <button onclick="testConnection()" style="background: #007bff; margin-top: 1rem;">Test Connection</button>
      <button onclick="testBasicFunctionality()" style="background: #28a745; margin-top: 1rem;">Test Basic Functions</button>
      <button onclick="checkNetworkStatus()" style="background: #ffc107; margin-top: 1rem;">Check Network</button>
      <div id="phaseStatus"></div>
      <div id="networkStatus" style="margin-top: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;"></div>
    </div>
  <div class="section">
    <h2>üõçÔ∏è Shopping Budget</h2>
    <p>Enter store total:</p>
    <input type="number" id="storeAmount" placeholder="e.g. 23.45" step="0.01" min="0" />
    <button onclick="addPurchase()">Submit</button>
    <div id="remaining">$100.00 remaining</div>
  </div>
  
  <script>
    // Initialize Supabase client with proper error handling
    let supabase;
    
    function initializeSupabase() {
      try {
        if (typeof window.supabase === 'undefined') {
          console.error('Supabase not loaded! Check the script tag.');
          throw new Error('Supabase library not loaded');
        }
        
        supabase = window.supabase.createClient(
          'https://bqrmdpuknvatplszalkz.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcm1kcHVrbnZhdHBsc2FsemxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MTY5NTEsImV4cCI6MjA2OTQ5Mjk1MX0.0BkkuelQ-8qW3OX-waPXHllFxYEziKq84FiJrGvWpYE'
        );
        
        console.log('Supabase client initialized:', supabase);
        return true;
      } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        showStatus(`Supabase initialization failed: ${error.message}`, 'error');
        return false;
      }
    }
    
    // Try to initialize immediately
    if (!initializeSupabase()) {
      // If immediate initialization fails, try again after a delay
      setTimeout(() => {
        if (!initializeSupabase()) {
          alert('Error: Could not initialize Supabase. Please refresh the page.');
        }
      }, 2000);
    }
    
    let budget = 100.00;

    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up admin panel...');
      
      // Load saved budget
      const stored = localStorage.getItem('remainingBudget');
      if (stored) {
        budget = parseFloat(stored);
        const remainingElement = document.getElementById('remaining');
        if (remainingElement) {
          remainingElement.innerText = `$${budget.toFixed(2)} remaining`;
        }
      }
      
      // Ensure Supabase is initialized before testing
      if (supabase) {
        setTimeout(() => {
          testConnection();
        }, 1000);
      } else {
        // Wait a bit longer for Supabase to load
        setTimeout(() => {
          if (supabase) {
            testConnection();
          } else {
            showStatus('Supabase not ready. Please refresh the page.', 'error');
          }
        }, 3000);
      }
    });

    function addPurchase() {
      const input = document.getElementById('storeAmount');
      const value = parseFloat(input.value);
      if (!isNaN(value) && value > 0) {
        budget -= value;
        budget = Math.max(0, budget);
        document.getElementById('remaining').innerText = `$${budget.toFixed(2)} remaining`;
        input.value = '';
        localStorage.setItem('remainingBudget', budget);
      } else {
        alert("Enter a valid number");
      }
    }

    async function sendPhase(phase) {
      try {
        console.log(`Attempting to send phase ${phase}...`);
        
        if (!supabase) {
          throw new Error('Supabase client not initialized');
        }
        
        console.log('Supabase client status:', supabase);
        
        // Create a timeout promise
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Request timeout - network may be slow')), 10000);
        });
        
        // Test the connection first with timeout
        const testPromise = supabase
          .from('phases')
          .select('*')
          .eq('id', 1)
          .single();
        
        const testResult = await Promise.race([testPromise, timeoutPromise]);
        
        console.log('Test query result:', testResult);
        
        if (testResult.error) {
          throw new Error(`Connection test failed: ${testResult.error.message}`);
        }
        
        // Update phase with timeout
        const updatePromise = supabase
          .from('phases')
          .update({ current: phase })
          .eq('id', 1)
          .select();
        
        const { data, error } = await Promise.race([updatePromise, timeoutPromise]);
        
        if (!error) {
          console.log('Phase update successful:', data);
          showStatus(`Phase ${phase} sent successfully!`, 'success');
          // Store locally as backup
          localStorage.setItem('currentPhase', phase);
        } else {
          console.error('Error updating phase:', error);
          showStatus(`Error sending phase: ${error.message}`, 'error');
          // Store locally as fallback
          localStorage.setItem('currentPhase', phase);
          showStatus(`Phase ${phase} stored locally as fallback`, 'success');
        }
      } catch (error) {
        console.error('Error in sendPhase:', error);
        showStatus(`Error sending phase: ${error.message}`, 'error');
        // Store locally as fallback
        localStorage.setItem('currentPhase', phase);
        showStatus(`Phase ${phase} stored locally as fallback`, 'success');
      }
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('phaseStatus');
      if (statusDiv) {
        statusDiv.innerText = message;
        statusDiv.className = `status ${type}`;
        
        // Clear status after 3 seconds
        setTimeout(() => {
          statusDiv.innerText = '';
          statusDiv.className = '';
        }, 3000);
      } else {
        console.log(`Status: ${message}`);
      }
    }

    async function testConnection() {
      try {
        console.log('Testing Supabase connection...');
        
        if (!supabase) {
          throw new Error('Supabase client not initialized');
        }
        
        const { data, error } = await supabase
          .from('phases')
          .select('*')
          .eq('id', 1)
          .single();
        
        if (error) {
          console.error('Connection test failed:', error);
          showStatus(`Connection failed: ${error.message}`, 'error');
        } else {
          console.log('Current phase data:', data);
          showStatus(`Connected! Current phase: ${data.current}`, 'success');
        }
      } catch (error) {
        console.error('Test connection error:', error);
        showStatus(`Test failed: ${error.message}`, 'error');
      }
    }

    function testBasicFunctionality() {
      console.log('Testing basic functionality...');
      
      // Test if functions are accessible
      console.log('Functions available:', {
        sendPhase: typeof sendPhase,
        testConnection: typeof testConnection,
        showStatus: typeof showStatus,
        addPurchase: typeof addPurchase
      });
      
      // Test if DOM elements exist
      const elements = {
        phaseStatus: document.getElementById('phaseStatus'),
        storeAmount: document.getElementById('storeAmount'),
        remaining: document.getElementById('remaining')
      };
      
      console.log('DOM elements found:', elements);
      
      // Test showStatus function
      showStatus('Basic functionality test - this should work!', 'success');
      
      // Test budget functionality
      const testValue = 10.50;
      budget -= testValue;
      const remainingElement = document.getElementById('remaining');
      if (remainingElement) {
        remainingElement.innerText = `$${budget.toFixed(2)} remaining`;
        showStatus(`Budget test: Subtracted $${testValue}`, 'success');
      }
      
      // Restore budget
      budget += testValue;
      if (remainingElement) {
        remainingElement.innerText = `$${budget.toFixed(2)} remaining`;
      }
    }

    async function checkNetworkStatus() {
      const networkStatus = document.getElementById('networkStatus');
      networkStatus.innerHTML = 'Checking network status...';
      
      try {
        // Test basic internet connectivity
        const response = await fetch('https://httpbin.org/get', { 
          method: 'GET',
          mode: 'no-cors'
        });
        
        let status = '‚úÖ Internet connection: OK<br>';
        
        // Test Supabase connectivity
        if (supabase) {
          try {
            const { data, error } = await supabase
              .from('phases')
              .select('*')
              .limit(1);
            
            if (error) {
              status += `‚ùå Supabase connection: ${error.message}<br>`;
            } else {
              status += '‚úÖ Supabase connection: OK<br>';
            }
          } catch (error) {
            status += `‚ùå Supabase connection: ${error.message}<br>`;
          }
        } else {
          status += '‚ùå Supabase client: Not initialized<br>';
        }
        
        // Check if Supabase script loaded
        if (typeof window.supabase !== 'undefined') {
          status += '‚úÖ Supabase library: Loaded<br>';
        } else {
          status += '‚ùå Supabase library: Not loaded<br>';
        }
        
        networkStatus.innerHTML = status;
      } catch (error) {
        networkStatus.innerHTML = `‚ùå Network check failed: ${error.message}`;
      }
    }

    window.onload = function() {
      const stored = localStorage.getItem('remainingBudget');
      if (stored) {
        budget = parseFloat(stored);
        const remainingElement = document.getElementById('remaining');
        if (remainingElement) {
          remainingElement.innerText = `$${budget.toFixed(2)} remaining`;
        }
      }
    };
  </script>
</body>
</html>
